<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ulam Spirals | Graphics Labs</title>
    <style>
        /* --- ESTILOS BASE (Mismos que Magic Square) --- */
        :root {
            --primary: #00ff41; /* Verde Matrix */
            --secondary: #bd00ff;
            --highlight: #ffee00;
            --glass: rgba(20, 20, 20, 0.7);
            --glass-text: rgba(30, 30, 30, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --muted: #aaaaaa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', monospace, sans-serif; }
        
        body {
            background-color: #050505;
            color: var(--text);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            user-select: none;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        .container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- CONTROLES --- */
        .controls {
            background: var(--glass);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 20px auto;
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .input-group { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; justify-content: center; }
        
        label { color: var(--muted); font-size: 0.9rem; }

        input[type="number"] {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px;
            border-radius: 5px;
            width: 100px;
            font-size: 1.1rem;
            text-align: center;
        }

        button.action-btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            text-transform: uppercase;
            font-size: 1rem;
        }
        button.action-btn:hover { box-shadow: 0 0 15px var(--primary); transform: scale(1.05); }
        
        button.secondary-btn {
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button.secondary-btn:hover { background: var(--secondary); color: #fff; box-shadow: 0 0 15px var(--secondary); }

        /* --- VISUALIZADOR CANVAS --- */
        #canvas-container {
            width: 100%;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
            /* Scrollbar personalizada */
            scrollbar-width: thin;
            scrollbar-color: var(--primary) #111;
        }
        
        #canvas-container::-webkit-scrollbar { height: 8px; width: 8px; }
        #canvas-container::-webkit-scrollbar-track { background: #111; }
        #canvas-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 4px; }

        #ulam-canvas {
            background: #000;
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            cursor: crosshair;
            margin-bottom: 10px;
            max-width: 100%; /* Responsive por defecto */
        }

        /* --- INFO & ADS --- */
        .info-section {
            background: var(--glass-text);
            padding: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 40px auto;
            max-width: 900px;
            text-align: left;
            line-height: 1.8;
            color: #ddd;
        }
        .info-section h2 { color: var(--primary); margin-bottom: 20px; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .info-section p { margin-bottom: 20px; font-size: 1rem; text-align: justify; }
        .math-highlight { color: var(--highlight); font-family: monospace; background: rgba(255, 238, 0, 0.1); padding: 2px 5px; border-radius: 3px; }

        .ad-container {
            width: 100%;
            max-width: 728px;
            margin: 30px auto;
            min-height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px dashed rgba(255,255,255,0.1); 
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
        }
        .ad-placeholder-text { color: var(--border); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; }

        /* Nav & Footer */
        nav { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-links { display: flex; gap: 15px; }
        .nav-btn { text-decoration: none; color: var(--muted); font-size: 0.9rem; border: 1px solid var(--border); padding: 5px 10px; border-radius: 4px; transition: 0.3s; background: rgba(0,0,0,0.5); }
        .nav-btn:hover { color: var(--primary); border-color: var(--primary); }
        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); text-decoration: none; letter-spacing: 2px; }
        
        .lang-switch button { background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: var(--muted); padding: 5px 10px; cursor: pointer; border-radius: 4px; margin-left: 2px;}
        .lang-switch button.active { background: var(--primary); color: #000; }
        
        footer { margin-top: auto; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); border-top: 1px solid var(--border); padding: 30px 20px; text-align: center; font-size: 0.8rem; color: var(--muted); display: flex; flex-direction: column; gap: 15px; align-items: center; position: relative; z-index: 20; }
        .legal-links { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
        .legal-links a { color: var(--muted); text-decoration: none; transition: 0.3s; border-bottom: 1px solid transparent; }
        .legal-links a:hover { color: var(--primary); border-bottom-color: var(--primary); }

        .coffee-btn { background: linear-gradient(45deg, #FFDD00, #FBB03B); color: #000; padding: 8px 15px; border-radius: 20px; text-decoration: none; font-weight: bold; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; transition: transform 0.2s; }
        .coffee-btn:hover { transform: scale(1.05); }

    </style>
</head>
<body oncontextmenu="return false;">

    <canvas id="bg-canvas"></canvas>

    <div class="container">
        <nav>
            <div class="nav-links">
                <a href="../../index.html" class="nav-btn">‚Üê HUB PRINCIPAL</a>
                <a href="../index.html" class="nav-btn">‚Üê HUB MATH</a>
            </div>
            <div class="logo">GRAPHICS LABS</div>
            <div class="lang-switch">
                <button onclick="setLang('es')" id="btn-es" class="active">ES</button>
                <button onclick="setLang('ca')" id="btn-ca">CA</button>
                <button onclick="setLang('en')" id="btn-en">EN</button>
                <button onclick="setLang('fr')" id="btn-fr">FR</button>
                <button onclick="setLang('de')" id="btn-de">DE</button>
                <button onclick="setLang('pt')" id="btn-pt">PT</button>
                <button onclick="setLang('it')" id="btn-it">IT</button>
                <button onclick="setLang('nl')" id="btn-nl">NL</button>
                <button onclick="setLang('ja')" id="btn-ja">JP</button>
            </div>
        </nav>

        <h1 id="txt-title">ESPIRAL DE ULAM</h1>
        <p style="color:var(--muted); margin-bottom: 20px;" id="txt-desc">Visualizaci√≥n de la distribuci√≥n de n√∫meros primos en un patr√≥n en espiral.</p>

        <div class="controls">
            <div class="input-group">
                <div>
                    <label id="lbl-max">M√°ximo (N):</label><br>
                    <input type="number" id="inp-max" value="40000" min="100" max="1000000" step="1000">
                </div>
                <div>
                    <label id="lbl-zoom">Zoom (px):</label><br>
                    <input type="number" id="inp-zoom" value="2" min="1" max="10">
                </div>
                <div>
                    <label id="lbl-start">Inicio:</label><br>
                    <input type="number" id="inp-start" value="1" min="1">
                </div>
            </div>
            <div class="input-group">
                <button class="action-btn" onclick="generateSpiral()" id="btn-gen">GENERAR</button>
                <button class="secondary-btn" onclick="saveImage()" id="btn-save">üíæ JPG</button>
            </div>
        </div>

        <div id="canvas-container">
            <canvas id="ulam-canvas" width="800" height="800"></canvas>
            <p style="color:var(--muted); font-size: 0.8rem; margin-top:5px;" id="txt-canvas-note">Haz clic derecho para guardar (si est√° habilitado) o usa el bot√≥n de guardar.</p>
        </div>

        <div class="info-section">
            <h2 id="info-h-history">El Hallazgo Accidental</h2>
            <p id="info-p1">
                En 1963, el matem√°tico polaco <strong>Stanislaw Ulam</strong> se encontraba en una reuni√≥n cient√≠fica. Presa del aburrimiento, comenz√≥ a garabatear n√∫meros enteros consecutivos en una cuadr√≠cula, empezando por el 1 en el centro y movi√©ndose en espiral hacia afuera. Instintivamente, marc√≥ los <span class="math-highlight">n√∫meros primos</span>.
            </p>
            <p id="info-p2">
                Lo que emergi√≥ no fue una distribuci√≥n aleatoria, sino un patr√≥n ordenado. Los n√∫meros primos mostraban una extra√±a tendencia a alinearse a lo largo de l√≠neas diagonales. Esto fue sorprendente porque contradice la intuici√≥n de que los n√∫meros primos aparecen de forma pseudo-aleatoria e impredecible.
            </p>

            <h2 id="info-h-math">La Matem√°tica del Patr√≥n</h2>
            <p id="info-p3">
                Las l√≠neas diagonales, horizontales y verticales visibles en la espiral corresponden a polinomios cuadr√°ticos. Por ejemplo, la diagonal m√°s prominente a menudo se relaciona con el famoso polinomio de Euler: <span class="math-highlight">f(n) = n¬≤ + n + 41</span>, que genera una densidad inusualmente alta de n√∫meros primos.
            </p>
            <p id="info-p4">
                En esta herramienta de <strong>Graphics Labs</strong>, cada punto verde brillante representa un n√∫mero primo. Al aumentar el n√∫mero "M√°ximo (N)" y reducir el "Zoom", puedes observar estructuras a gran escala que se asemejan a galaxias o circuitos integrados, revelando la belleza oculta en la teor√≠a de n√∫meros.
            </p>
        </div>

        <div class="ad-container"><span class="ad-placeholder-text">Ad Space</span></div>
    </div>

    <footer>
        <div class="legal-links">
            <a href="../../legal.html" id="link-legal">Aviso Legal</a>
            <a href="../../privacy.html" id="link-privacy">Pol√≠tica de Privacidad</a>
            <a href="../../cookies.html" id="link-cookies">Pol√≠tica de Cookies</a>
            <a href="mailto:pbazan@gmail.com" id="link-contact">Contacto</a>
        </div>
        <span id="footer-rights">¬© 2025 Graphics Labs</span>
        <a href="https://paypal.me/pbazan" target="_blank" class="coffee-btn">
            ‚òï <span id="btn-coffee">Inv√≠tame a un caf√©</span>
        </a>
    </footer>

    <script>
        /* --- 1. SEGURIDAD --- */
        document.addEventListener('keydown', function(e) {
            if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
                e.preventDefault();
            }
        });

        /* --- 2. TRADUCCIONES --- */
        const translations = {
            'es': {
                title: "ESPIRAL DE ULAM", desc: "Visualizaci√≥n de la distribuci√≥n de n√∫meros primos en un patr√≥n en espiral.",
                lbl_max: "M√°ximo (N):", lbl_zoom: "Grosor (px):", lbl_start: "N√∫mero Inicio:",
                btn_gen: "GENERAR", btn_save: "GUARDAR JPG",
                note: "Los puntos verdes son n√∫meros primos.",
                history_title: "El Hallazgo Accidental",
                p1: "En 1963, el matem√°tico Stanislaw Ulam descubri√≥ este patr√≥n por aburrimiento en una reuni√≥n. Al escribir n√∫meros en espiral y marcar los primos, not√≥ alineaciones diagonales.",
                p2: "Esto sugiere que los n√∫meros primos no son tan aleatorios como parecen, sino que siguen ciertas funciones cuadr√°ticas.",
                math_title: "La Matem√°tica del Patr√≥n",
                p3: "Las diagonales corresponden a polinomios como el de Euler: n¬≤ + n + 41. Esta herramienta permite visualizar estas 'galaxias matem√°ticas'.",
                p4: "Aumenta el n√∫mero m√°ximo para ver la estructura a gran escala.",
                legal: "Aviso Legal", privacy: "Pol√≠tica de Privacidad", cookies: "Cookies", contact: "Contacto", coffee: "Inv√≠tame a un caf√©"
            },
            'en': {
                title: "ULAM SPIRAL", desc: "Visualization of prime number distribution in a spiral pattern.",
                lbl_max: "Maximum (N):", lbl_zoom: "Dot Size:", lbl_start: "Start Num:",
                btn_gen: "GENERATE", btn_save: "SAVE JPG",
                note: "Green dots represent prime numbers.",
                history_title: "The Accidental Discovery",
                p1: "In 1963, mathematician Stanislaw Ulam discovered this pattern while doodling during a boring meeting. Marking primes in a number spiral revealed diagonal alignments.",
                p2: "This suggests primes aren't purely random but align with quadratic functions.",
                math_title: "The Mathematics",
                p3: "Diagonals correspond to polynomials like Euler's n¬≤ + n + 41. This tool lets you visualize these 'math galaxies'.",
                p4: "Increase the maximum number to see large-scale structures.",
                legal: "Legal Notice", privacy: "Privacy Policy", cookies: "Cookies", contact: "Contact", coffee: "Buy me a coffee"
            },
            'ca': {
                title: "ESPIRAL D'ULAM", desc: "Visualitzaci√≥ de la distribuci√≥ de nombres primers en un patr√≥ en espiral.",
                lbl_max: "M√†xim (N):", lbl_zoom: "Gruix (px):", lbl_start: "Nombre Inici:",
                btn_gen: "GENERAR", btn_save: "DESAR JPG",
                note: "Els punts verds s√≥n nombres primers.",
                history_title: "La Troballa Accidental",
                p1: "El 1963, el matem√†tic Stanislaw Ulam va descobrir aquest patr√≥ per avorriment. En escriure nombres en espiral i marcar els primers, va notar alineacions diagonals.",
                p2: "Aix√≤ suggereix que els nombres primers no s√≥n tan aleatoris com semblen.",
                math_title: "La Matem√†tica del Patr√≥",
                p3: "Les diagonals corresponen a polinomis com el d'Euler: n¬≤ + n + 41.",
                p4: "Augmenta el nombre m√†xim per veure l'estructura a gran escala.",
                legal: "Av√≠s Legal", privacy: "Pol√≠tica de Privacitat", cookies: "Cookies", contact: "Contacte", coffee: "Convida'm a un caf√®"
            },
            // Idiomas restantes (simplificados para brevedad, en producci√≥n llenar todos)
            'fr': { title: "SPIRALE D'ULAM", btn_gen: "G√âN√âRER", btn_save: "ENREGISTRER", lbl_max: "Maximum", lbl_zoom: "Zoom", lbl_start: "D√©but", history_title: "D√©couverte", p1: "D√©couvert par Ulam en 1963.", math_title: "Math√©matiques", p3: "Polyn√¥me d'Euler.", legal: "Mentions", privacy: "Confidentialit√©", cookies: "Cookies", contact: "Contact", coffee: "Caf√©" },
            'de': { title: "ULAM-SPIRALE", btn_gen: "GENERIEREN", btn_save: "SPEICHERN", lbl_max: "Maximum", lbl_zoom: "Zoom", lbl_start: "Start", history_title: "Entdeckung", p1: "1963 von Ulam entdeckt.", math_title: "Mathematik", p3: "Euler-Polynom.", legal: "Impressum", privacy: "Datenschutz", cookies: "Cookies", contact: "Kontakt", coffee: "Kaffee" },
            'pt': { title: "ESPIRAL DE ULAM", btn_gen: "GERAR", btn_save: "SALVAR", lbl_max: "M√°ximo", lbl_zoom: "Zoom", lbl_start: "In√≠cio", history_title: "Descoberta", p1: "Descoberto por Ulam em 1963.", math_title: "Matem√°tica", p3: "Polin√¥mio de Euler.", legal: "Aviso", privacy: "Privacidade", cookies: "Cookies", contact: "Contato", coffee: "Caf√©" },
            'it': { title: "SPIRALE DI ULAM", btn_gen: "GENERARE", btn_save: "SALVARE", lbl_max: "Massimo", lbl_zoom: "Zoom", lbl_start: "Inizio", history_title: "Scoperta", p1: "Scoperto da Ulam nel 1963.", math_title: "Matematica", p3: "Polinomio di Eulero.", legal: "Legale", privacy: "Privacy", cookies: "Cookies", contact: "Contatto", coffee: "Caff√®" },
            'nl': { title: "ULAM SPIRAAL", btn_gen: "GENEREREN", btn_save: "OPSLAAN", lbl_max: "Maximum", lbl_zoom: "Zoom", lbl_start: "Start", history_title: "Ontdekking", p1: "Ontdekt door Ulam in 1963.", math_title: "Wiskunde", p3: "Euler's Polynoom.", legal: "Juridisch", privacy: "Privacy", cookies: "Cookies", contact: "Contact", coffee: "Koffie" },
            'ja': { title: "„Ç¶„É©„É†„ÅÆËû∫Êóã", btn_gen: "ÁîüÊàê", btn_save: "‰øùÂ≠ò", lbl_max: "ÊúÄÂ§ßÂÄ§", lbl_zoom: "„Ç∫„Éº„É†", lbl_start: "ÈñãÂßã", history_title: "Áô∫Ë¶ã", p1: "1963Âπ¥„Å´„Ç¶„É©„É†„ÅåÁô∫Ë¶ã„ÄÇ", math_title: "Êï∞Â≠¶", p3: "„Ç™„Ç§„É©„Éº„ÅÆÂ§öÈ†ÖÂºè„ÄÇ", legal: "Ê≥ïÁöÑ", privacy: "„Éó„É©„Ç§„Éê„Ç∑„Éº", cookies: "„ÇØ„ÉÉ„Ç≠„Éº", contact: "Êé•Ëß¶", coffee: "„Ç≥„Éº„Éí„Éº" }
        };

        let currentLang = 'es';

        function setLang(lang) {
            localStorage.setItem('gl_lang', lang);
            currentLang = lang;
            const t = translations[lang] || translations['es']; // Fallback
            
            document.getElementById('txt-title').innerText = t.title;
            if(t.desc) document.getElementById('txt-desc').innerText = t.desc;
            
            document.getElementById('lbl-max').innerText = t.lbl_max;
            document.getElementById('lbl-zoom').innerText = t.lbl_zoom;
            document.getElementById('lbl-start').innerText = t.lbl_start;
            document.getElementById('btn-gen').innerText = t.btn_gen;
            document.getElementById('btn-save').innerText = t.btn_save;

            if(t.history_title) document.getElementById('info-h-history').innerText = t.history_title;
            if(t.p1) document.getElementById('info-p1').innerText = t.p1;
            if(t.p2) document.getElementById('info-p2').innerText = t.p2;
            if(t.math_title) document.getElementById('info-h-math').innerText = t.math_title;
            if(t.p3) document.getElementById('info-p3').innerText = t.p3;
            if(t.p4) document.getElementById('info-p4').innerText = t.p4;

            document.getElementById('link-legal').innerText = t.legal;
            document.getElementById('link-privacy').innerText = t.privacy;
            document.getElementById('link-cookies').innerText = t.cookies;
            document.getElementById('link-contact').innerText = t.contact;
            document.getElementById('btn-coffee').innerText = t.coffee;

            document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
        }

        /* --- 3. FONDO DE PART√çCULAS (MATH THEME) --- */
        const bgCanvas = document.getElementById('bg-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        let particlesArray = [];
        
        function resizeBg() {
            bgCanvas.width = window.innerWidth;
            bgCanvas.height = window.innerHeight;
        }
        window.addEventListener('resize', () => { resizeBg(); initParticles(); });
        resizeBg();

        const mouse = { x: null, y: null, radius: 150 };
        window.addEventListener('mousemove', (e) => { mouse.x = e.x; mouse.y = e.y; });

        class Particle {
            constructor() {
                this.x = Math.random() * bgCanvas.width;
                this.y = Math.random() * bgCanvas.height;
                this.size = Math.random() * 12 + 8;
                this.baseX = this.x;
                this.baseY = this.y;
                this.density = (Math.random() * 30) + 1;
                // S√≠mbolos matem√°ticos
                const symbols = ['œÄ', '‚àû', '‚àë', '‚à´', '‚àö', '‚âà', '‚â†', '0', '1', 'e'];
                this.text = symbols[Math.floor(Math.random() * symbols.length)];
            }
            draw() {
                bgCtx.font = this.size + 'px monospace';
                bgCtx.fillStyle = 'rgba(0, 255, 65, 0.2)';
                bgCtx.fillText(this.text, this.x, this.y);
            }
            update() {
                let dx = mouse.x - this.x;
                let dy = mouse.y - this.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                let forceDirectionX = dx / distance;
                let forceDirectionY = dy / distance;
                let maxDistance = mouse.radius;
                let force = (maxDistance - distance) / maxDistance;
                let directionX = forceDirectionX * force * this.density;
                let directionY = forceDirectionY * force * this.density;

                if (distance < mouse.radius) {
                    this.x -= directionX * 5; // Huyen del rat√≥n
                    this.y -= directionY * 5;
                } else {
                    if (this.x !== this.baseX) {
                        let dx = this.x - this.baseX;
                        this.x -= dx/10;
                    }
                    if (this.y !== this.baseY) {
                        let dy = this.y - this.baseY;
                        this.y -= dy/10;
                    }
                }
                this.draw();
            }
        }

        function initParticles() {
            particlesArray = [];
            // Densidad de part√≠culas
            let numberOfParticles = (bgCanvas.height * bgCanvas.width) / 9000;
            for (let i = 0; i < numberOfParticles; i++) {
                particlesArray.push(new Particle());
            }
        }
        
        function animateParticles() {
            bgCtx.clearRect(0, 0, bgCanvas.width, bgCanvas.height);
            for (let i = 0; i < particlesArray.length; i++) {
                particlesArray[i].update();
            }
            requestAnimationFrame(animateParticles);
        }
        initParticles();
        animateParticles();

        /* --- 4. L√ìGICA ESPIRAL DE ULAM --- */
        const ulamCanvas = document.getElementById('ulam-canvas');
        const ctx = ulamCanvas.getContext('2d');

        function isPrime(num) {
            if (num <= 1) return false;
            if (num <= 3) return true;
            if (num % 2 === 0 || num % 3 === 0) return false;
            for (let i = 5; i * i <= num; i += 6) {
                if (num % i === 0 || num % (i + 2) === 0) return false;
            }
            return true;
        }

        function generateSpiral() {
            let max = parseInt(document.getElementById('inp-max').value);
            let start = parseInt(document.getElementById('inp-start').value);
            let zoom = parseInt(document.getElementById('inp-zoom').value);
            
            // Validaciones
            if (max < 100) max = 100;
            if (zoom < 1) zoom = 1;
            
            // Calcular tama√±o del canvas basado en la cantidad de n√∫meros (√°rea)
            // Lado del cuadrado ‚âà ra√≠z cuadrada de max
            const spiralSide = Math.ceil(Math.sqrt(max));
            const canvasSize = (spiralSide * zoom) + (zoom * 20); // padding

            // Limitar tama√±o m√°ximo para evitar crash del navegador
            const MAX_DIM = 4000;
            let finalW = canvasSize;
            if (finalW > MAX_DIM) finalW = MAX_DIM;

            ulamCanvas.width = finalW;
            ulamCanvas.height = finalW;

            // Fondo negro
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, ulamCanvas.width, ulamCanvas.height);

            let x = Math.floor(ulamCanvas.width / 2);
            let y = Math.floor(ulamCanvas.height / 2);
            
            // Direcciones: Derecha(0), Arriba(1), Izquierda(2), Abajo(3)
            // Coordenadas pantalla: x aumenta derecha, y aumenta abajo.
            // Derecha: x+1, y0. Arriba: x0, y-1. Izq: x-1, y0. Abajo: x0, y+1.
            const dx = [1, 0, -1, 0];
            const dy = [0, -1, 0, 1];
            let dir = 0;

            let stepsInSegment = 1;
            let stepsTaken = 0;
            let turnCounter = 0;

            let currentNum = start;

            // Optimizaci√≥n de dibujo: dibujar solo primos
            ctx.fillStyle = '#00ff41'; // Verde Matrix

            for (let i = 0; i < max; i++) {
                // Verificar l√≠mites de dibujo
                if (x >= 0 && x < ulamCanvas.width && y >= 0 && y < ulamCanvas.height) {
                    if (isPrime(currentNum)) {
                        // Dibujar punto
                        if (zoom === 1) {
                            ctx.fillRect(x, y, 1, 1);
                        } else {
                            // C√≠rculo peque√±o para zoom > 1 queda m√°s bonito
                            ctx.beginPath();
                            ctx.arc(x + zoom/2, y + zoom/2, zoom/2.5, 0, Math.PI*2);
                            ctx.fill();
                        }
                    }
                }

                // Mover
                x += dx[dir] * zoom;
                y += dy[dir] * zoom;
                
                currentNum++;
                stepsTaken++;

                // L√≥gica de giro espiral
                if (stepsTaken === stepsInSegment) {
                    stepsTaken = 0;
                    dir = (dir + 1) % 4;
                    turnCounter++;
                    if (turnCounter % 2 === 0) {
                        stepsInSegment++;
                    }
                }
            }
        }

        function saveImage() {
            const link = document.createElement('a');
            link.download = 'graphics_labs_ulam.jpg';
            link.href = ulamCanvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        // Inicializar
        const saved = localStorage.getItem('gl_lang') || 'es';
        setLang(saved);
        setTimeout(generateSpiral, 100); // Peque√±o delay para asegurar carga

    </script>
</body>
</html>
