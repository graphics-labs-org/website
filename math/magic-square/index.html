<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Square Lab | Graphics Labs</title>
    <style>
        :root {
            --primary: #00ff41; /* Verde Matrix para Math */
            --secondary: #bd00ff;
            --highlight: #ffee00;
            --glass: rgba(20, 20, 20, 0.7);
            --glass-text: rgba(30, 30, 30, 0.8);
            --border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --muted: #aaaaaa;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', monospace, sans-serif; }
        
        body {
            background-color: #050505;
            color: var(--text);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            user-select: none;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }

        .container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- CONTROLES --- */
        .controls {
            background: var(--glass);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 20px auto;
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
        
        input[type="number"] {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px;
            border-radius: 5px;
            width: 80px;
            font-size: 1.2rem;
            text-align: center;
        }

        button.action-btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            text-transform: uppercase;
        }
        button.action-btn:hover { box-shadow: 0 0 15px var(--primary); transform: scale(1.05); }

        button.sagrada-btn {
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }
        button.sagrada-btn:hover { background: var(--secondary); color: #fff; box-shadow: 0 0 15px var(--secondary); }
        
        button.download-btn {
            background: rgba(255,255,255,0.1);
            color: var(--text);
            border: 1px solid var(--muted);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button.download-btn:hover { background: rgba(255,255,255,0.2); border-color: #fff; }

        .formula-box {
            font-family: 'Courier New', monospace;
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 10px 0;
            min-height: 1.5em;
            text-shadow: 0 0 5px rgba(189, 0, 255, 0.4);
            font-weight: bold;
            transition: 0.3s;
            padding: 10px;
            border-radius: 8px;
        }
        .formula-box.interactive { cursor: pointer; border: 1px dashed rgba(189, 0, 255, 0.3); }
        .formula-box.interactive:hover { background: rgba(189, 0, 255, 0.1); border-color: var(--secondary); }
        .formula-box.interactive::after { content: 'üëÜ'; font-size: 0.8em; margin-left: 10px; opacity: 0.5; }

        .hint-text {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-style: italic;
            opacity: 0;
            animation: fadeIn 1s forwards 0.5s;
        }

        /* DISPLAY DE RESULTADOS SAGRADA */
        #sagrada-display {
            background: rgba(189, 0, 255, 0.1);
            border: 1px solid var(--secondary);
            color: #fff;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-family: monospace;
            min-height: 40px;
            display: none; /* Se activa solo en modo sagrada */
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
        }

        /* --- GRID M√ÅGICO --- */
        #magic-container {
            width: 100%;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        #magic-grid {
            display: grid;
            gap: 3px;
            margin: 0 auto;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,1);
        }

        .cell {
            background: rgba(0, 255, 65, 0.05);
            border: 1px solid rgba(0, 255, 65, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            border-radius: 4px;
            transition: 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .cell:hover { background: rgba(0, 255, 65, 0.2); color: #fff; }

        .cell.active-trace {
            background: var(--highlight) !important;
            color: #000 !important;
            box-shadow: 0 0 15px var(--highlight);
            transform: scale(1.05);
            z-index: 20;
            font-weight: bold;
            border-color: #fff !important;
        }

        .cell.selected-origin {
            background: #fff !important;
            color: #000 !important;
            box-shadow: 0 0 20px #fff;
            transform: scale(1.15);
            z-index: 30;
        }

        .cell.dense { background: #111; border: none; font-family: monospace; color: var(--primary); cursor: default; }
        .sagrada-highlight { border-color: var(--secondary) !important; color: var(--secondary) !important; font-weight: bold; }
        .sum-highlight { background: var(--highlight) !important; color: #000 !important; box-shadow: 0 0 15px var(--highlight); transform: scale(1.05); z-index: 20; font-weight: bold; border-color: #fff !important; }

        /* --- INFO & ADS --- */
        .info-section {
            background: var(--glass-text);
            padding: 40px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 40px auto;
            max-width: 800px;
            text-align: left;
            line-height: 1.6;
            color: #ddd;
        }
        .info-section h2 { color: var(--primary); margin-bottom: 20px; font-size: 1.5rem; text-transform: uppercase; letter-spacing: 1px; }
        .info-section h3 { color: var(--secondary); margin-top: 20px; margin-bottom: 10px; font-size: 1.1rem; }
        .info-section p { margin-bottom: 15px; font-size: 0.95rem; }
        .info-section ul { margin-left: 20px; margin-bottom: 15px; }
        .info-section li { margin-bottom: 5px; }

        .ad-container {
            width: 100%;
            max-width: 728px;
            margin: 30px auto;
            min-height: 90px;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px dashed rgba(255,255,255,0.1); 
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
        }
        .ad-placeholder-text { color: var(--border); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; }

        /* Nav & Footer */
        nav { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav-links { display: flex; gap: 15px; }
        .nav-btn { text-decoration: none; color: var(--muted); font-size: 0.9rem; border: 1px solid var(--border); padding: 5px 10px; border-radius: 4px; transition: 0.3s; background: rgba(0,0,0,0.5); }
        .nav-btn:hover { color: var(--primary); border-color: var(--primary); }
        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); text-decoration: none; letter-spacing: 2px; }
        
        .lang-switch button { background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: var(--muted); padding: 5px 10px; cursor: pointer; border-radius: 4px; margin-left: 2px;}
        .lang-switch button.active { background: var(--primary); color: #000; }
        
        footer { margin-top: auto; background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); border-top: 1px solid var(--border); padding: 30px 20px; text-align: center; font-size: 0.8rem; color: var(--muted); display: flex; flex-direction: column; gap: 15px; align-items: center; position: relative; z-index: 20; }
        .legal-links { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
        .legal-links a { color: var(--muted); text-decoration: none; transition: 0.3s; border-bottom: 1px solid transparent; }
        .legal-links a:hover { color: var(--primary); border-bottom-color: var(--primary); }

        .coffee-btn { background: linear-gradient(45deg, #FFDD00, #FBB03B); color: #000; padding: 8px 15px; border-radius: 20px; text-decoration: none; font-weight: bold; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; transition: transform 0.2s; }
        .coffee-btn:hover { transform: scale(1.05); }

    </style>
</head>
<body oncontextmenu="return false;">

    <canvas id="bg-canvas"></canvas>

    <div class="container">
        <nav>
            <div class="nav-links">
                <a href="../../index.html" class="nav-btn">‚Üê HUB PRINCIPAL</a>
                <a href="../index.html" class="nav-btn">‚Üê HUB MATH</a>
            </div>
            <div class="logo">GRAPHICS LABS</div>
            <div class="lang-switch">
                <button onclick="setLang('es')" id="btn-es" class="active">ES</button>
                <button onclick="setLang('ca')" id="btn-ca">CA</button>
                <button onclick="setLang('en')" id="btn-en">EN</button>
                <button onclick="setLang('fr')" id="btn-fr">FR</button>
                <button onclick="setLang('de')" id="btn-de">DE</button>
                <button onclick="setLang('pt')" id="btn-pt">PT</button>
                <button onclick="setLang('it')" id="btn-it">IT</button>
                <button onclick="setLang('nl')" id="btn-nl">NL</button>
                <button onclick="setLang('ja')" id="btn-ja">JP</button>
            </div>
        </nav>

        <h1 id="txt-title">CUADRADO M√ÅGICO</h1>
        <p style="color:var(--muted); margin-bottom: 20px;" id="txt-desc">Generador universal (pares e impares). El caos se convierte en orden.</p>

        <div class="controls">
            <div class="input-group">
                <label id="lbl-size">Tama√±o:</label>
                <input type="number" id="size-input" value="3" min="3" max="100" step="1">
                <button class="action-btn" onclick="generateUserSquare()" id="btn-gen">GENERAR</button>
            </div>
            <div style="width: 100%; height: 1px; background: var(--border); margin: 10px 0;"></div>
            <button class="sagrada-btn" onclick="generateSagrada()" id="btn-sagrada">ver SAGRADA FAMILIA (4x4)</button>
        </div>

        <div class="formula-box" id="formula-display" onclick="highlightSums()"></div>
        
        <div id="sagrada-display"></div>
        
        <div class="hint-text" id="txt-hint">Haz clic en un n√∫mero para ver sus conexiones.</div>

        <div id="magic-container">
            <div id="magic-grid"></div>
            <button onclick="downloadASCII()" class="download-btn" id="btn-download" style="display:none;">
                üíæ <span id="txt-download">Descargar TXT</span>
            </button>
        </div>

        <div class="info-section">
            <h2 id="info-title">Sobre los Cuadrados M√°gicos</h2>
            <p id="info-p1">Un cuadrado m√°gico es una disposici√≥n de n√∫meros en una cuadr√≠cula de N x N...</p>
            <h3 id="info-h-hist">Historia y Curiosidades</h3>
            <p id="info-p2">Desde el 'Lo Shu' chino hasta la Sagrada Familia...</p>
            <h3 id="info-h-tool">Caracter√≠sticas del Laboratorio</h3>
            <p id="info-p3">Explora las matem√°ticas visuales:</p>
            <ul id="info-ul">
                <li>Generaci√≥n ilimitada...</li>
                <li>Algoritmos para impares...</li>
                <li>Visualizaci√≥n de trazas...</li>
                <li>Descarga de patrones...</li>
            </ul>
        </div>

        <div class="ad-container"><span class="ad-placeholder-text">Ad Space</span></div>
    </div>

    <footer>
        <div class="legal-links">
            <a href="../../legal.html" id="link-legal">Aviso Legal</a>
            <a href="../../privacy.html" id="link-privacy">Pol√≠tica de Privacidad</a>
            <a href="../../cookies.html" id="link-cookies">Pol√≠tica de Cookies</a>
            <a href="mailto:pbazan@gmail.com" id="link-contact">Contacto</a>
        </div>
        <span id="footer-rights">¬© 2025 Graphics Labs</span>
        <a href="https://paypal.me/pbazan" target="_blank" class="coffee-btn">
            ‚òï <span id="btn-coffee">Inv√≠tame a un caf√©</span>
        </a>
    </footer>

    <script>
        let currentMatrix = [];
        let isSagradaMode = false;
        let sagradaCombinations = [];
        let animationInterval;

        const translations = {
            'es': {
                title: "CUADRADO M√ÅGICO", desc: "Generador universal (pares e impares). El caos se convierte en orden.", lbl_size: "Tama√±o (N):", btn_gen: "GENERAR", btn_sagrada: "ver SAGRADA FAMILIA (4x4)", formula: "Constante M√°gica: ", sagrada_note: "Nota: Cuadrado de Subirachs (Suma 33, Edad de Cristo).", hint: "Haz clic en un n√∫mero para ver sus conexiones.", download: "Descargar TXT",
                info_title: "Sobre los Cuadrados M√°gicos", info_p1: "Un cuadrado m√°gico es una disposici√≥n de n√∫meros en una cuadr√≠cula de N x N, donde la suma de cada fila, columna y diagonal es id√©ntica.", info_h_hist: "Historia y Curiosidades", info_p2: "Desde el 'Lo Shu' chino hasta la Sagrada Familia de Barcelona. El cuadrado de Josep Maria Subirachs en la fachada de la Pasi√≥n suma 33 (la edad de Cristo) en 310 combinaciones distintas.", info_h_tool: "Caracter√≠sticas del Laboratorio", info_p3: "Explora las matem√°ticas visuales:", info_li1: "Generaci√≥n ilimitada de 3x3 a 100x100.", info_li2: "Algoritmos para impares, pares y doblemente pares.", info_li3: "Visualizaci√≥n de trazas y conexiones.", info_li4: "Descarga de patrones en archivo de texto.",
                legal: "Aviso Legal", privacy: "Pol√≠tica de Privacidad", cookies: "Pol√≠tica de Cookies", contact: "Contacto", coffee: "Inv√≠tame a un caf√©", combo_found: "combinaciones suman 33 con este n√∫mero."
            },
            'ca': {
                title: "QUADRAT M√ÄGIC", desc: "Generador universal (parells i senars). El caos es converteix en ordre.", lbl_size: "Mida (N):", btn_gen: "GENERAR", btn_sagrada: "veure SAGRADA FAM√çLIA (4x4)", formula: "Constant M√†gica: ", sagrada_note: "Nota: Quadrat de Subirachs (Suma 33, Edat de Crist).", hint: "Fes clic en un n√∫mero per veure les seves connexions.", download: "Descarregar TXT",
                info_title: "Sobre els Quadrats M√†gics", info_p1: "Un quadrat m√†gic √©s una disposici√≥ de nombres en una quadr√≠cula de N x N, on la suma de cada fila, columna i diagonal √©s id√®ntica.", info_h_hist: "Hist√≤ria i Curiositats", info_p2: "Des del 'Lo Shu' xin√®s fins a la Sagrada Fam√≠lia de Barcelona. El quadrat de Josep Maria Subirachs a la fa√ßana de la Passi√≥ suma 33 (l'edat de Crist) en 310 combinacions diferents.", info_h_tool: "Caracter√≠stiques del Laboratori", info_p3: "Explora les matem√†tiques visuals:", info_li1: "Generaci√≥ il¬∑limitada de 3x3 a 100x100.", info_li2: "Algorismes per a senars, parells i doblement parells.", info_li3: "Visualitzaci√≥ de traces i connexions.", info_li4: "Desc√†rrega de patrons en fitxer de text.",
                legal: "Av√≠s Legal", privacy: "Pol√≠tica de Privacitat", cookies: "Pol√≠tica de Cookies", contact: "Contacte", coffee: "Convidam a un caf√®", combo_found: "combinacions sumen 33 amb aquest n√∫mero."
            },
            // ... (Resto de idiomas igual que antes, solo a√±adiendo combo_found si quieres)
            'en': { title: "MAGIC SQUARE", desc: "Universal generator.", lbl_size: "Size (N):", btn_gen: "GENERATE", btn_sagrada: "view SAGRADA FAMILIA", formula: "Magic Constant: ", sagrada_note: "Sums 33.", hint: "Click number to trace.", download: "Download TXT", info_title: "About", info_p1: "...", info_h_hist: "History", info_p2: "...", info_h_tool: "Features", info_p3: "...", info_li1: "...", info_li2: "...", info_li3: "...", info_li4: "...", legal: "Legal", privacy: "Privacy", cookies: "Cookies", contact: "Contact", coffee: "Coffee", combo_found: "combinations sum to 33 using this number." },
            'fr': { title: "CARR√â MAGIQUE", desc: "G√©n√©rateur universel.", lbl_size: "Taille (N):", btn_gen: "G√âN√âRER", btn_sagrada: "voir SAGRADA FAMILIA", formula: "Constante: ", sagrada_note: "Somme 33.", hint: "Cliquez pour tracer.", download: "T√©l√©charger", info_title: "√Ä propos", info_p1: "...", info_h_hist: "Histoire", info_p2: "...", info_h_tool: "Fonctions", info_p3: "...", info_li1: "...", info_li2: "...", info_li3: "...", info_li4: "...", legal: "Mentions", privacy: "Confidentialit√©", cookies: "Cookies", contact: "Contact", coffee: "Caf√©", combo_found: "combinaisons totalisent 33 avec ce nombre." },
            'de': { title: "MAGISCHES QUADRAT", desc: "Universalgenerator.", lbl_size: "Gr√∂√üe (N):", btn_gen: "ERZEUGEN", btn_sagrada: "siehe SAGRADA FAMILIA", formula: "Konstante: ", sagrada_note: "Summe 33.", hint: "Klicken zum Verfolgen.", download: "Download", info_title: "√úber", info_p1: "...", info_h_hist: "Geschichte", info_p2: "...", info_h_tool: "Funktionen", info_p3: "...", info_li1: "...", info_li2: "...", info_li3: "...", info_li4: "...", legal: "Impressum", privacy: "Datenschutz", cookies: "Cookies", contact: "Kontakt", coffee: "Kaffee", combo_found: "Kombinationen ergeben 33 mit dieser Zahl." },
            'pt': { title: "QUADRADO M√ÅGICO", desc: "Gerador universal.", lbl_size: "Tamanho (N):", btn_gen: "GERAR", btn_sagrada: "ver SAGRADA FAMILIA", formula: "Constante: ", sagrada_note: "Soma 33.", hint: "Clique para tra√ßar.", download: "Baixar", info_title: "Sobre", info_p1: "...", info_h_hist: "Hist√≥ria", info_p2: "...", info_h_tool: "Recursos", info_p3: "...", info_li1: "...", info_li2: "...", info_li3: "...", info_li4: "...", legal: "Aviso", privacy: "Privacidade", cookies: "Cookies", contact: "Contato", coffee: "Caf√©", combo_found: "combina√ß√µes somam 33 com este n√∫mero." },
            'it': { title: "QUADRATO MAGICO", desc: "Generatore universale.", lbl_size: "Dimensione (N):", btn_gen: "GENERARE", btn_sagrada: "vedi SAGRADA FAMILIA", formula: "Costante: ", sagrada_note: "Somma 33.", hint: "Clicca per tracciare.", download: "Scarica", info_title: "Info", info_p1: "...", info_h_hist: "Storia", info_p2: "...", info_h_tool: "Funzioni", info_p3: "...", info_li1: "...", info_li2: "...", info_li3: "...", info_li4: "...", legal: "Avviso", privacy: "Privacy", cookies: "Cookies", contact: "Contatto", coffee: "Caff√®", combo_found: "combinazioni sommano 33 con questo numero." },
            'nl': { title: "MAGISCH VIERKANT", desc: "Universele generator.", lbl_size: "Grootte (N):", btn_gen: "GENEREREN", btn_sagrada: "zie SAGRADA FAMILIA", formula: "Constante: ", sagrada_note: "Som 33.", hint: "Klik om te volgen.", download: "Download", info_title: "Over", info_p1: "...", info_h_hist: "Geschiedenis", info_p2: "...", info_h_tool: "Functies", info_p3: "...", info_li1: "...", info_li2: "...", info_li3: "...", info_li4: "...", legal: "Juridisch", privacy: "Privacy", cookies: "Cookies", contact: "Contact", coffee: "Koffie", combo_found: "combinaties tellen op tot 33 met dit nummer." },
            'ja': { title: "È≠îÊñπÈô£", desc: "„É¶„Éã„Éê„Éº„Çµ„É´„Ç∏„Çß„Éç„É¨„Éº„Çø„Éº„ÄÇ", lbl_size: "„Çµ„Ç§„Ç∫ (N):", btn_gen: "ÁîüÊàê„Åô„Çã", btn_sagrada: "„Çµ„Ç∞„É©„ÉÄ„Éª„Éï„Ç°„Éü„É™„Ç¢", formula: "ÂÆöÊï∞: ", sagrada_note: "ÂêàË®à 33.", hint: "„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Éà„É¨„Éº„Çπ„ÄÇ", download: "„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ", info_title: "Á¥Ñ", info_p1: "...", info_h_hist: "Ê≠¥Âè≤", info_p2: "...", info_h_tool: "ÁâπÂæ¥", info_p3: "...", info_li1: "...", info_li2: "...", info_li3: "...", info_li4: "...", legal: "Ê≥ïÁöÑ", privacy: "„Éó„É©„Ç§„Éê„Ç∑„Éº", cookies: "„ÇØ„ÉÉ„Ç≠„Éº", contact: "Êé•Ëß¶", coffee: "„Ç≥„Éº„Éí„Éº", combo_found: "„Åì„ÅÆÊï∞Â≠ó„ÇíÂê´„ÇÄÁµÑ„ÅøÂêà„Çè„Åõ„ÅØÂêàË®à33„Å´„Å™„Çä„Åæ„Åô„ÄÇ" }
        };

        let currentLang = 'es';

        function setLang(lang) {
            localStorage.setItem('gl_lang', lang);
            currentLang = lang;
            const t = translations[lang];
            
            document.getElementById('txt-title').innerText = t.title;
            document.getElementById('txt-desc').innerText = t.desc;
            document.getElementById('lbl-size').innerText = t.lbl_size;
            document.getElementById('btn-gen').innerText = t.btn_gen;
            document.getElementById('btn-sagrada').innerText = t.btn_sagrada;
            document.getElementById('txt-download').innerText = t.download;
            document.getElementById('txt-hint').innerText = t.hint;
            
            // Info text (reusing ES text for others if lazy, but structure is there)
            if(t.info_title) {
                document.getElementById('info-title').innerText = t.info_title;
                document.getElementById('info-p1').innerText = t.info_p1;
                document.getElementById('info-h-hist').innerText = t.info_h_hist;
                document.getElementById('info-p2').innerText = t.info_p2;
                document.getElementById('info-h-tool').innerText = t.info_h_tool;
                document.getElementById('info-p3').innerText = t.info_p3;
                const ul = document.getElementById('info-ul');
                ul.children[0].innerText = t.info_li1;
                ul.children[1].innerText = t.info_li2;
                ul.children[2].innerText = t.info_li3;
                ul.children[3].innerText = t.info_li4;
            }

            document.getElementById('link-legal').innerText = t.legal;
            document.getElementById('link-privacy').innerText = t.privacy;
            document.getElementById('link-cookies').innerText = t.cookies;
            document.getElementById('link-contact').innerText = t.contact;
            document.getElementById('btn-coffee').innerText = t.coffee;
            
            document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
            
            if(currentMatrix.length > 0) {
                const formulaBox = document.getElementById('formula-display');
                if (isSagradaMode) formulaBox.innerText = t.formula + "33 (" + t.sagrada_note + ")";
                else {
                    const n = currentMatrix.length;
                    const magicConstant = (n * (n*n + 1)) / 2;
                    formulaBox.innerText = t.formula + magicConstant;
                }
            }
        }

        /* --- LOGICA SAGRADA (33 Finder) --- */
        function findAllCombinationsOf4(arr) {
            // Brute force all combinations of 4 cells from 16 (1820 combos) that sum to 33
            const n = 4;
            const combos = [];
            // arr is flat array of 16 values
            for(let a=0; a<16; a++) {
                for(let b=a+1; b<16; b++) {
                    for(let c=b+1; c<16; c++) {
                        for(let d=c+1; d<16; d++) {
                            const sum = arr[a] + arr[b] + arr[c] + arr[d];
                            if(sum === 33) {
                                combos.push([a, b, c, d]);
                            }
                        }
                    }
                }
            }
            return combos;
        }

        function showSagradaCombinations(clickedIndex) {
            // Detener animaciones anteriores
            clearInterval(animationInterval);
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => {
                c.classList.remove('active-trace'); 
                c.classList.remove('selected-origin');
                c.style.background = '';
            });

            // Encontrar combinaciones que incluyan este indice
            const relevantCombos = sagradaCombinations.filter(combo => combo.includes(clickedIndex));
            
            if(relevantCombos.length === 0) return;

            // Marcar origen
            cells[clickedIndex].classList.add('selected-origin');

            const display = document.getElementById('sagrada-display');
            display.style.display = 'flex';
            
            let currentIndex = 0;

            function playAnimation() {
                // Limpiar frame anterior
                cells.forEach(c => {
                    if(!c.classList.contains('selected-origin')) {
                        c.classList.remove('sum-highlight');
                        c.style.background = '';
                    }
                });

                const combo = relevantCombos[currentIndex];
                const vals = [];
                
                combo.forEach(idx => {
                    cells[idx].classList.add('sum-highlight');
                    vals.push(cells[idx].innerText);
                });

                // Texto del display
                const t = translations[currentLang] || translations['es'];
                display.innerText = `Combo ${currentIndex + 1}/${relevantCombos.length}: ${vals.join(' + ')} = 33`;

                currentIndex = (currentIndex + 1) % relevantCombos.length;
            }

            playAnimation(); // Primera inmediata
            animationInterval = setInterval(playAnimation, 2000); // Siguientes cada 2s
        }

        /* --- GENERACI√ìN --- */
        function generateUserSquare() {
            clearInterval(animationInterval);
            document.getElementById('sagrada-display').style.display = 'none';
            isSagradaMode = false; 
            let n = parseInt(document.getElementById('size-input').value);
            if(n < 3) n = 3; if(n > 100) n = 100;
            document.getElementById('size-input').value = n;

            const magicConstant = (n * (n*n + 1)) / 2;
            document.getElementById('formula-display').innerText = (translations[currentLang] || translations['es']).formula + magicConstant;
            
            const fBox = document.getElementById('formula-display');
            if(n <= 10) fBox.classList.add('interactive'); else fBox.classList.remove('interactive');

            if (n % 2 !== 0) currentMatrix = generateOdd(n);
            else if (n % 4 === 0) currentMatrix = generateDoublyEven(n);
            else currentMatrix = generateSinglyEven(n);

            drawGrid(currentMatrix, n);
            document.getElementById('btn-download').style.display = 'flex';
        }

        function generateSagrada() {
            clearInterval(animationInterval);
            isSagradaMode = true; 
            currentMatrix = [
                [1, 14, 14, 4],
                [11, 7, 6, 9],
                [8, 10, 10, 5],
                [13, 2, 3, 15]
            ];
            // Flatten for solver
            const flatMatrix = currentMatrix.flat();
            sagradaCombinations = findAllCombinationsOf4(flatMatrix);

            document.getElementById('formula-display').innerText = (translations[currentLang] || translations['es']).formula + "33 (" + (translations[currentLang] || translations['es']).sagrada_note + ")";
            document.getElementById('sagrada-display').style.display = 'flex';
            document.getElementById('sagrada-display').innerText = (translations[currentLang] || translations['es']).hint;

            drawGrid(currentMatrix, 4, true);
            document.getElementById('btn-download').style.display = 'flex';
        }

        /* --- LOGICA TRACE GENERICO --- */
        function traceLines(r, c) {
            // Si es sagrada, usa la logica especial
            if(isSagradaMode) {
                const idx = r * 4 + c;
                showSagradaCombinations(idx);
                return;
            }

            const n = currentMatrix.length;
            if(n > 20) return; 

            const cells = document.querySelectorAll('.cell');
            const originIndex = r * n + c;
            const clickedCell = cells[originIndex];

            if (clickedCell.classList.contains('selected-origin')) {
                cells.forEach(cell => { cell.classList.remove('active-trace'); cell.classList.remove('selected-origin'); });
                return;
            }
            cells.forEach(cell => { cell.classList.remove('active-trace'); cell.classList.remove('selected-origin'); });
            clickedCell.classList.add('selected-origin');

            for(let j=0; j<n; j++) if(j !== c) cells[r*n + j].classList.add('active-trace');
            for(let i=0; i<n; i++) if(i !== r) cells[i*n + c].classList.add('active-trace');
            if(r === c) for(let i=0; i<n; i++) if(i !== r) cells[i*n + i].classList.add('active-trace');
            if(r + c === n - 1) for(let i=0; i<n; i++) { let j = (n - 1) - i; if(i !== r) cells[i*n + j].classList.add('active-trace'); }
        }

        function highlightSums() {
            const n = currentMatrix.length; if(n > 10) return;
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => c.classList.remove('sum-highlight'));
            setTimeout(() => {
                for(let i=0; i<n; i++) for(let j=0; j<n; j++) cells[i*n + j].classList.add('sum-highlight');
                setTimeout(() => { cells.forEach(c => c.classList.remove('sum-highlight')); }, 3000);
            }, 50);
        }

        // ALGORITMOS (Igual que antes)
        function generateOdd(n) { let s=Array.from({length:n},()=>Array(n).fill(0)); let i=0,j=Math.floor(n/2); for(let k=1;k<=n*n;k++){s[i][j]=k; let ni=(i-1+n)%n,nj=(j+1)%n; if(s[ni][nj]!==0)i=(i+1)%n; else{i=ni;j=nj;}} return s; }
        function generateDoublyEven(n) { let s=Array.from({length:n},()=>Array(n).fill(0)); for(let i=0;i<n;i++)for(let j=0;j<n;j++)s[i][j]=(n*i)+j+1; for(let i=0;i<n;i++)for(let j=0;j<n;j++){ let corner=(i%4==0||i%4==3)&&(j%4==0||j%4==3); let center=(i%4==1||i%4==2)&&(j%4==1||j%4==2); if(corner||center)s[i][j]=(n*n+1)-s[i][j]; } return s; }
        function generateSinglyEven(n) { let h=n/2,sg=generateOdd(h),g=Array.from({length:n},()=>Array(n).fill(0)),k=h*h; for(let i=0;i<h;i++)for(let j=0;j<h;j++){g[i][j]=sg[i][j]; g[i+h][j+h]=sg[i][j]+k; g[i][j+h]=sg[i][j]+2*k; g[i+h][j]=sg[i][j]+3*k;} let sc=Math.floor(n/4); for(let i=0;i<h;i++)for(let j=0;j<sc;j++){if(i==Math.floor(h/2))swap(g,i,j+1,i+h,j+1);else swap(g,i,j,i+h,j);} let m=sc-1; if(m>0)for(let i=0;i<h;i++)for(let j=0;j<m;j++){let c=n-1-j;swap(g,i,c,i+h,c);} return g; }
        function swap(g,r1,c1,r2,c2){let t=g[r1][c1];g[r1][c1]=g[r2][c2];g[r2][c2]=t;}

        function drawGrid(matrix, size, isSpecial = false) {
            const container = document.getElementById('magic-grid');
            container.innerHTML = '';
            let cellSize, fontSize; let isDense = false;
            if (size <= 10) { cellSize = '50px'; fontSize = '1.2rem'; } else if (size <= 20) { cellSize = '35px'; fontSize = '1rem'; } else if (size <= 50) { cellSize = '25px'; fontSize = '0.7rem'; isDense = true; } else { cellSize = '15px'; fontSize = '0.5rem'; isDense = true; }
            container.style.gridTemplateColumns = `repeat(${size}, ${cellSize})`;
            let useDelay = size < 15;
            const hint = document.getElementById('txt-hint');
            if(size > 20) hint.style.display = 'none'; else hint.style.display = 'block';

            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    let val = matrix[i][j];
                    let div = document.createElement('div');
                    div.className = isDense ? 'cell dense' : 'cell fancy';
                    if (isSpecial && (val === 10 || val === 14)) div.classList.add('sagrada-highlight');
                    div.style.width = cellSize; div.style.height = cellSize; div.style.fontSize = fontSize; div.innerText = val;
                    if(!isDense) div.onclick = function() { traceLines(i, j); };
                    if (useDelay) { div.style.opacity = '0'; div.style.animation = `fadeIn 0.3s forwards ${ (i*size + j) * 0.01 }s`; } else div.style.opacity = '1';
                    container.appendChild(div);
                }
            }
        }

        function downloadASCII() {
            if(!currentMatrix || currentMatrix.length === 0) return;
            const n = currentMatrix.length;
            const maxNum = n*n; const padSize = maxNum.toString().length + 1;
            let content = `GRAPHICS LABS - MAGIC SQUARE (N=${n})\n`;
            content += `Magic Constant: ${document.getElementById('formula-display').innerText.split(': ')[1]}\n`;
            content += "=".repeat(n * padSize) + "\n\n";
            for(let row of currentMatrix) { let line = ""; for(let num of row) line += num.toString().padStart(padSize, ' '); content += line + "\n"; }
            const blob = new Blob([content], { type: 'text/plain' }); const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `magic_square_${n}x${n}.txt`; a.click(); window.URL.revokeObjectURL(url);
        }

        const canvas = document.getElementById('bg-canvas'); const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particlesArray; let mouse = { x: null, y: null, radius: (canvas.height/100) * (canvas.width/100) };
        window.addEventListener('mousemove', function(e) { mouse.x = e.x; mouse.y = e.y; });
        class Particle {
            constructor(x, y, dx, dy, size) { this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.size = size; this.number = Math.floor(Math.random() * 10); }
            draw() { ctx.font = this.size + 'px monospace'; ctx.fillStyle = 'rgba(0, 255, 65, 0.4)'; ctx.fillText(this.number, this.x, this.y); }
            update() { if(this.x>canvas.width||this.x<0) this.dx=-this.dx; if(this.y>canvas.height||this.y<0) this.dy=-this.dy; let dx = mouse.x - this.x; let dy = mouse.y - this.y; let dist = Math.sqrt(dx*dx + dy*dy); if(dist < mouse.radius + 50){ if(mouse.x<this.x && this.x<canvas.width-50) this.x+=2; if(mouse.x>this.x && this.x>50) this.x-=2; if(mouse.y<this.y && this.y<canvas.height-50) this.y+=2; if(mouse.y>this.y && this.y>50) this.y-=2; } this.x+=this.dx*0.5; this.y+=this.dy*0.5; this.draw(); }
        }
        function init(){ particlesArray=[]; let n=(canvas.height*canvas.width)/6000; for(let i=0; i<n; i++){ let size=(Math.random()*15)+10; particlesArray.push(new Particle(Math.random()*innerWidth, Math.random()*innerHeight, (Math.random()*1)-0.5, (Math.random()*1)-0.5, size)); } }
        function animate(){ requestAnimationFrame(animate); ctx.clearRect(0,0,innerWidth,innerHeight); for(let i=0; i<particlesArray.length; i++){ particlesArray[i].update(); } }
        window.addEventListener('resize', ()=>{canvas.width=innerWidth;canvas.height=innerHeight;init();});
        init(); animate();

        const styleSheet = document.createElement("style"); styleSheet.innerText = `@keyframes fadeIn { to { opacity: 1; } }`; document.head.appendChild(styleSheet);
        
        const savedLang = localStorage.getItem('gl_lang') || 'es';
        setLang(savedLang);
        generateUserSquare();
    </script>
</body>
</html>
