<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Square Lab | Graphics Labs</title>
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #bd00ff;
            --highlight: #ffee00; /* Amarillo el√©ctrico para el rastro */
            --glass: rgba(20, 20, 20, 0.7);
            --border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --muted: #888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', monospace, sans-serif; }
        
        body {
            background-color: #050505;
            color: var(--text);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            user-select: none;
        }

        #bg-canvas { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            z-index: 0; 
        }

        .container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- CONTROLES --- */
        .controls {
            background: var(--glass);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 20px auto;
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
        
        input[type="number"] {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px;
            border-radius: 5px;
            width: 80px;
            font-size: 1.2rem;
            text-align: center;
        }

        button.action-btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            text-transform: uppercase;
        }
        button.action-btn:hover { box-shadow: 0 0 15px var(--primary); transform: scale(1.05); }

        button.sagrada-btn {
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }
        button.sagrada-btn:hover { background: var(--secondary); color: #fff; box-shadow: 0 0 15px var(--secondary); }
        
        button.download-btn {
            background: rgba(255,255,255,0.1);
            color: var(--text);
            border: 1px solid var(--muted);
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        button.download-btn:hover { background: rgba(255,255,255,0.2); border-color: #fff; }

        .formula-box {
            font-family: 'Courier New', monospace;
            color: var(--secondary);
            font-size: 1.3rem;
            margin: 10px 0;
            min-height: 1.5em;
            text-shadow: 0 0 5px rgba(189, 0, 255, 0.4);
            font-weight: bold;
        }

        .hint-text {
            color: var(--muted);
            font-size: 0.85rem;
            margin-bottom: 5px;
            font-style: italic;
            opacity: 0;
            animation: fadeIn 1s forwards 0.5s;
        }

        /* --- GRID M√ÅGICO --- */
        #magic-container {
            width: 100%;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin-bottom: 20px;
            position: relative;
            z-index: 10;
        }

        #magic-grid {
            display: grid;
            gap: 3px;
            margin: 0 auto;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0,0,0,1);
        }

        .cell {
            background: rgba(0, 243, 255, 0.05);
            border: 1px solid rgba(0, 243, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ccc;
            border-radius: 4px;
            transition: 0.2s;
            cursor: pointer;
            position: relative;
        }
        
        .cell:hover { 
            background: rgba(0, 243, 255, 0.2);
            color: #fff;
        }

        /* HIGHLIGHT: El rastro m√°gico */
        .cell.active-trace {
            background: var(--highlight) !important;
            color: #000 !important;
            box-shadow: 0 0 15px var(--highlight);
            transform: scale(1.05);
            z-index: 20;
            font-weight: bold;
            border-color: #fff !important;
        }

        /* Highlight de la celda CLICADA */
        .cell.selected-origin {
            background: #fff !important;
            color: #000 !important;
            box-shadow: 0 0 20px #fff;
            transform: scale(1.15);
            z-index: 30;
        }

        .cell.dense {
            background: #111;
            border: none;
            font-family: monospace;
            color: var(--primary);
            cursor: default;
        }

        .sagrada-highlight { border-color: var(--secondary) !important; color: var(--secondary) !important; font-weight: bold; }

        /* Nav & Footer */
        nav { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .nav-links { display: flex; gap: 15px; }
        .nav-btn { 
            text-decoration: none; 
            color: var(--muted); 
            font-size: 0.9rem; 
            border: 1px solid var(--border); 
            padding: 5px 10px; 
            border-radius: 4px; 
            transition: 0.3s;
            background: rgba(0,0,0,0.5);
        }
        .nav-btn:hover { color: var(--primary); border-color: var(--primary); }

        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); text-decoration: none; letter-spacing: 2px; }
        
        .lang-switch button { background: rgba(0,0,0,0.5); border: 1px solid var(--border); color: var(--muted); padding: 5px 10px; cursor: pointer; border-radius: 4px; margin-left: 2px;}
        .lang-switch button.active { background: var(--primary); color: #000; }
        
        footer {
            margin-top: auto;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(5px);
            border-top: 1px solid var(--border);
            padding: 30px 20px;
            text-align: center;
            font-size: 0.8rem;
            color: var(--muted);
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            position: relative;
            z-index: 20;
        }

        .legal-links { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 10px; }
        .legal-links a { color: var(--muted); text-decoration: none; transition: 0.3s; border-bottom: 1px solid transparent; }
        .legal-links a:hover { color: var(--primary); border-bottom-color: var(--primary); }

        .coffee-btn {
            background: linear-gradient(45deg, #FFDD00, #FBB03B);
            color: #000;
            padding: 8px 15px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: bold;
            font-size: 0.85rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: transform 0.2s;
        }
        .coffee-btn:hover { transform: scale(1.05); }

    </style>
</head>
<body oncontextmenu="return false;">

    <canvas id="bg-canvas"></canvas>

    <div class="container">
        <nav>
            <div class="nav-links">
                <a href="../../index.html" class="nav-btn">‚Üê HUB PRINCIPAL</a>
                <a href="#" class="nav-btn" style="opacity:0.5; cursor: default;">‚Üê HUB MATH</a>
            </div>
            <div class="logo">GRAPHICS LABS</div>
            <div class="lang-switch">
                <button onclick="setLang('es')" id="btn-es" class="active">ES</button>
                <button onclick="setLang('en')" id="btn-en">EN</button>
                <button onclick="setLang('fr')" id="btn-fr">FR</button>
                <button onclick="setLang('de')" id="btn-de">DE</button>
                <button onclick="setLang('pt')" id="btn-pt">PT</button>
                <button onclick="setLang('it')" id="btn-it">IT</button>
                <button onclick="setLang('nl')" id="btn-nl">NL</button>
                <button onclick="setLang('ja')" id="btn-ja">JP</button>
            </div>
        </nav>

        <h1 id="txt-title">CUADRADO M√ÅGICO</h1>
        <p style="color:var(--muted); margin-bottom: 20px;" id="txt-desc">Generador universal (pares e impares). El caos se convierte en orden.</p>

        <div class="controls">
            <div class="input-group">
                <label id="lbl-size">Tama√±o:</label>
                <input type="number" id="size-input" value="3" min="3" max="100" step="1">
                <button class="action-btn" onclick="generateUserSquare()" id="btn-gen">GENERAR</button>
            </div>
            
            <div style="width: 100%; height: 1px; background: var(--border); margin: 10px 0;"></div>
            
            <button class="sagrada-btn" onclick="generateSagrada()" id="btn-sagrada">ver SAGRADA FAMILIA (4x4)</button>
        </div>

        <div class="formula-box" id="formula-display"></div>
        <div class="hint-text" id="txt-hint">Haz clic en un n√∫mero para ver sus conexiones.</div>

        <div id="magic-container">
            <div id="magic-grid"></div>
            <button onclick="downloadASCII()" class="download-btn" id="btn-download" style="display:none;">
                üíæ <span id="txt-download">Descargar TXT</span>
            </button>
        </div>

    </div>

    <footer>
        <div class="legal-links">
            <a href="../../legal.html" id="link-legal">Aviso Legal</a>
            <a href="../../privacy.html" id="link-privacy">Pol√≠tica de Privacidad</a>
            <a href="../../cookies.html" id="link-cookies">Pol√≠tica de Cookies</a>
        </div>
        <span id="footer-rights">¬© 2025 Graphics Labs</span>
        <a href="https://paypal.me/TU_USUARIO_PAYPAL" target="_blank" class="coffee-btn">
            ‚òï <span id="btn-coffee">Inv√≠tame a un caf√©</span>
        </a>
    </footer>

    <script>
        let currentMatrix = [];
        let isSagradaMode = false; 

        /* --- TRADUCCIONES --- */
        const translations = {
            'es': {
                title: "CUADRADO M√ÅGICO",
                desc: "Generador universal (pares e impares). El caos se convierte en orden.",
                lbl_size: "Tama√±o (N):",
                btn_gen: "GENERAR",
                btn_sagrada: "ver SAGRADA FAMILIA (4x4)",
                formula: "Constante M√°gica: ",
                sagrada_note: "Nota: Cuadrado de Subirachs (Suma 33, Edad de Cristo).",
                hint: "Haz clic en un n√∫mero para ver sus conexiones.",
                download: "Descargar TXT",
                legal: "Aviso Legal", privacy: "Pol√≠tica de Privacidad", cookies: "Pol√≠tica de Cookies", coffee: "Inv√≠tame a un caf√©"
            },
            'en': {
                title: "MAGIC SQUARE",
                desc: "Universal generator (odd & even). Chaos becomes order.",
                lbl_size: "Size (N):",
                btn_gen: "GENERATE",
                btn_sagrada: "view SAGRADA FAMILIA (4x4)",
                formula: "Magic Constant: ",
                sagrada_note: "Note: Subirachs Square (Sums 33, Age of Christ).",
                hint: "Click on a number to see its connections.",
                download: "Download TXT",
                legal: "Legal Notice", privacy: "Privacy Policy", cookies: "Cookies Policy", coffee: "Buy me a coffee"
            },
            'fr': {
                title: "CARR√â MAGIQUE",
                desc: "G√©n√©rateur universel (pair et impair). Le chaos devient ordre.",
                lbl_size: "Taille (N):",
                btn_gen: "G√âN√âRER",
                btn_sagrada: "voir SAGRADA FAMILIA (4x4)",
                formula: "Constante Magique: ",
                sagrada_note: "Note: Carr√© de Subirachs (Somme 33, √Çge du Christ).",
                hint: "Cliquez sur un nombre pour voir ses connexions.",
                download: "T√©l√©charger TXT",
                legal: "Mentions L√©gales", privacy: "Politique de Confidentialit√©", cookies: "Politique de Cookies", coffee: "Offrez-moi un caf√©"
            },
            'de': {
                title: "MAGISCHES QUADRAT",
                desc: "Universalgenerator (gerade & ungerade). Chaos wird Ordnung.",
                lbl_size: "Gr√∂√üe (N):",
                btn_gen: "ERZEUGEN",
                btn_sagrada: "siehe SAGRADA FAMILIA (4x4)",
                formula: "Magische Konstante: ",
                sagrada_note: "Hinweis: Subirachs Quadrat (Summe 33, Alter Christi).",
                hint: "Klicken Sie auf eine Zahl, um ihre Verbindungen zu sehen.",
                download: "TXT Herunterladen",
                legal: "Impressum", privacy: "Datenschutz", cookies: "Cookie-Richtlinie", coffee: "Kauf mir einen Kaffee"
            },
            'pt': {
                title: "QUADRADO M√ÅGICO",
                desc: "Gerador universal (pares e √≠mpares). O caos torna-se ordem.",
                lbl_size: "Tamanho (N):",
                btn_gen: "GERAR",
                btn_sagrada: "ver SAGRADA FAMILIA (4x4)",
                formula: "Constante M√°gica: ",
                sagrada_note: "Nota: Quadrado de Subirachs (Soma 33, Idade de Cristo).",
                hint: "Clique em um n√∫mero para ver suas conex√µes.",
                download: "Baixar TXT",
                legal: "Aviso Legal", privacy: "Pol√≠tica de Privacidade", cookies: "Pol√≠tica de Cookies", coffee: "Pague-me um caf√©"
            },
            'it': {
                title: "QUADRATO MAGICO",
                desc: "Generatore universale (pari e dispari). Il caos diventa ordine.",
                lbl_size: "Dimensione (N):",
                btn_gen: "GENERARE",
                btn_sagrada: "vedi SAGRADA FAMILIA (4x4)",
                formula: "Costante Magica: ",
                sagrada_note: "Nota: Quadrato di Subirachs (Somma 33, Et√† di Cristo).",
                hint: "Clicca su un numero per vedere le sue connessioni.",
                download: "Scarica TXT",
                legal: "Avviso Legale", privacy: "Privacy Policy", cookies: "Cookie Policy", coffee: "Offrimi un caff√®"
            },
            'nl': {
                title: "MAGISCH VIERKANT",
                desc: "Universele generator (even & oneven). Chaos wordt orde.",
                lbl_size: "Grootte (N):",
                btn_gen: "GENEREREN",
                btn_sagrada: "zie SAGRADA FAMILIA (4x4)",
                formula: "Magische Constante: ",
                sagrada_note: "Opmerking: Subirachs Vierkant (Som 33, Leeftijd van Christus).",
                hint: "Klik op een getal om de verbindingen te zien.",
                download: "Download TXT",
                legal: "Juridische kennisgeving", privacy: "Privacybeleid", cookies: "Cookiebeleid", coffee: "Koop een koffie voor me"
            },
            'ja': {
                title: "È≠îÊñπÈô£",
                desc: "„É¶„Éã„Éê„Éº„Çµ„É´„Ç∏„Çß„Éç„É¨„Éº„Çø„ÉºÔºàÂÅ∂Êï∞„Å®Â•áÊï∞Ôºâ„ÄÇ„Ç´„Ç™„Çπ„ÅåÁß©Â∫è„Å´„Å™„Çã„ÄÇ",
                lbl_size: "„Çµ„Ç§„Ç∫ (N):",
                btn_gen: "ÁîüÊàê„Åô„Çã",
                btn_sagrada: "„Çµ„Ç∞„É©„ÉÄ„Éª„Éï„Ç°„Éü„É™„Ç¢ (4x4)",
                formula: "È≠îÊ≥ïÂÆöÊï∞: ",
                sagrada_note: "Ê≥®Ôºö„Çπ„Éì„É©„ÇØ„Çπ„ÅÆÊñπÈô£ÔºàÂêàË®à33„ÄÅ„Ç≠„É™„Çπ„Éà„ÅÆÂπ¥ÈΩ¢Ôºâ„ÄÇ",
                hint: "Áï™Âè∑„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Êé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åô„ÄÇ",
                download: "TXT„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ",
                legal: "Ê≥ïÁöÑÈÄöÁü•", privacy: "„Éó„É©„Ç§„Éê„Ç∑„Éº„Éù„É™„Ç∑„Éº", cookies: "„ÇØ„ÉÉ„Ç≠„Éº„Éù„É™„Ç∑„Éº", coffee: "„Ç≥„Éº„Éí„Éº„ÇíÂ•¢„Çã"
            }
        };

        let currentLang = 'es';

        function setLang(lang) {
            currentLang = lang;
            const t = translations[lang];
            
            document.getElementById('txt-title').innerText = t.title;
            document.getElementById('txt-desc').innerText = t.desc;
            document.getElementById('lbl-size').innerText = t.lbl_size;
            document.getElementById('btn-gen').innerText = t.btn_gen;
            document.getElementById('btn-sagrada').innerText = t.btn_sagrada;
            document.getElementById('txt-download').innerText = t.download;
            document.getElementById('txt-hint').innerText = t.hint;
            
            document.getElementById('link-legal').innerText = t.legal;
            document.getElementById('link-privacy').innerText = t.privacy;
            document.getElementById('link-cookies').innerText = t.cookies;
            document.getElementById('btn-coffee').innerText = t.coffee;
            
            document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
            
            const formulaBox = document.getElementById('formula-display');
            if(currentMatrix.length > 0) {
                if (isSagradaMode) {
                    formulaBox.innerText = t.formula + "33 (" + t.sagrada_note + ")";
                } else {
                    const n = currentMatrix.length;
                    const magicConstant = (n * (n*n + 1)) / 2;
                    formulaBox.innerText = t.formula + magicConstant;
                }
            }
        }

        /* --- GENERACI√ìN --- */
        function generateUserSquare() {
            isSagradaMode = false; 
            let n = parseInt(document.getElementById('size-input').value);
            if(n < 3) n = 3; 
            if(n > 100) n = 100;
            document.getElementById('size-input').value = n;

            const magicConstant = (n * (n*n + 1)) / 2;
            document.getElementById('formula-display').innerText = translations[currentLang].formula + magicConstant;
            
            if (n % 2 !== 0) currentMatrix = generateOdd(n);
            else if (n % 4 === 0) currentMatrix = generateDoublyEven(n);
            else currentMatrix = generateSinglyEven(n);

            drawGrid(currentMatrix, n);
            document.getElementById('btn-download').style.display = 'flex';
        }

        function generateSagrada() {
            isSagradaMode = true; 
            currentMatrix = [
                [1, 14, 14, 4],
                [11, 7, 6, 9],
                [8, 10, 10, 5],
                [13, 2, 3, 15]
            ];
            document.getElementById('formula-display').innerText = translations[currentLang].formula + "33 (" + translations[currentLang].sagrada_note + ")";
            drawGrid(currentMatrix, 4, true);
            document.getElementById('btn-download').style.display = 'flex';
        }

        /* --- LOGICA DEL RASTRO (TRACE) --- */
        function traceLines(r, c) {
            const n = currentMatrix.length;
            if(n > 20) return; // Se desactiva para tama√±os grandes

            const cells = document.querySelectorAll('.cell');
            const originIndex = r * n + c;
            const clickedCell = cells[originIndex];

            // TOGGLE: Si ya estaba seleccionado, limpiamos y salimos
            if (clickedCell.classList.contains('selected-origin')) {
                cells.forEach(cell => {
                    cell.classList.remove('active-trace');
                    cell.classList.remove('selected-origin');
                });
                return;
            }

            // Si no estaba, limpiamos anteriores y dibujamos nuevo
            cells.forEach(cell => {
                cell.classList.remove('active-trace');
                cell.classList.remove('selected-origin');
            });

            // Marcar origen
            clickedCell.classList.add('selected-origin');

            // Marcar Fila
            for(let j=0; j<n; j++) {
                if(j !== c) cells[r*n + j].classList.add('active-trace');
            }

            // Marcar Columna
            for(let i=0; i<n; i++) {
                if(i !== r) cells[i*n + c].classList.add('active-trace');
            }

            // Marcar Diagonal Principal (si aplica)
            if(r === c) {
                for(let i=0; i<n; i++) {
                    if(i !== r) cells[i*n + i].classList.add('active-trace');
                }
            }

            // Marcar Anti-Diagonal (si aplica)
            if(r + c === n - 1) {
                for(let i=0; i<n; i++) {
                    let j = (n - 1) - i;
                    if(i !== r) cells[i*n + j].classList.add('active-trace');
                }
            }
        }

        /* --- ALGORITMOS MATEM√ÅTICOS --- */
        function generateOdd(n) {
            let square = Array.from({ length: n }, () => Array(n).fill(0));
            let i = 0, j = Math.floor(n / 2);
            for (let num = 1; num <= n * n; num++) {
                square[i][j] = num;
                let nextI = (i - 1 + n) % n;
                let nextJ = (j + 1) % n;
                if (square[nextI][nextJ] !== 0) i = (i + 1) % n;
                else { i = nextI; j = nextJ; }
            }
            return square;
        }

        function generateDoublyEven(n) {
            let square = Array.from({ length: n }, () => Array(n).fill(0));
            for (let i = 0; i < n; i++) 
                for (let j = 0; j < n; j++) square[i][j] = (n * i) + j + 1;
            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    let inCorner = (i % 4 === 0 || i % 4 === 3) && (j % 4 === 0 || j % 4 === 3);
                    let inCenter = (i % 4 === 1 || i % 4 === 2) && (j % 4 === 1 || j % 4 === 2);
                    if (inCorner || inCenter) square[i][j] = (n * n + 1) - square[i][j];
                }
            }
            return square;
        }

        function generateSinglyEven(n) {
            let halfN = n / 2;
            let subGrid = generateOdd(halfN);
            let grid = Array.from({ length: n }, () => Array(n).fill(0));
            let k = halfN * halfN;
            for (let i = 0; i < halfN; i++) {
                for (let j = 0; j < halfN; j++) {
                    grid[i][j] = subGrid[i][j];             
                    grid[i + halfN][j + halfN] = subGrid[i][j] + k; 
                    grid[i][j + halfN] = subGrid[i][j] + 2 * k; 
                    grid[i + halfN][j] = subGrid[i][j] + 3 * k; 
                }
            }
            let swapCols = Math.floor(n / 4);
            for (let i = 0; i < halfN; i++) {
                for (let j = 0; j < swapCols; j++) {
                    if (i === Math.floor(halfN / 2)) swap(grid, i, j + 1, i + halfN, j + 1);
                    else swap(grid, i, j, i + halfN, j);
                }
            }
            let m = swapCols - 1;
            if (m > 0) {
                for (let i = 0; i < halfN; i++) {
                    for (let j = 0; j < m; j++) {
                        let col = n - 1 - j;
                        swap(grid, i, col, i + halfN, col);
                    }
                }
            }
            return grid;
        }
        function swap(grid, r1, c1, r2, c2) { let temp = grid[r1][c1]; grid[r1][c1] = grid[r2][c2]; grid[r2][c2] = temp; }

        /* --- PINTADO DEL GRID --- */
        function drawGrid(matrix, size, isSpecial = false) {
            const container = document.getElementById('magic-grid');
            container.innerHTML = '';
            
            let cellSize, fontSize;
            let isDense = false;
            // Ajuste responsive
            if (size <= 10) { cellSize = '50px'; fontSize = '1.2rem'; }
            else if (size <= 20) { cellSize = '35px'; fontSize = '1rem'; }
            else if (size <= 50) { cellSize = '25px'; fontSize = '0.7rem'; isDense = true; }
            else { cellSize = '15px'; fontSize = '0.5rem'; isDense = true; }
            
            container.style.gridTemplateColumns = `repeat(${size}, ${cellSize})`;
            let useDelay = size < 15;

            // Mostrar/Ocultar hint
            const hint = document.getElementById('txt-hint');
            if(size > 20) hint.style.display = 'none'; // Se oculta si es > 20
            else hint.style.display = 'block';

            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    let val = matrix[i][j];
                    let div = document.createElement('div');
                    div.className = isDense ? 'cell dense' : 'cell fancy';
                    
                    if (isSpecial && (val === 10 || val === 14)) div.classList.add('sagrada-highlight');
                    
                    div.style.width = cellSize;
                    div.style.height = cellSize;
                    div.style.fontSize = fontSize;
                    div.innerText = val;
                    
                    // EVENTO DE CLIC PARA RASTRO (Solo si no es denso)
                    if(!isDense) {
                        div.onclick = function() { traceLines(i, j); };
                    }

                    if (useDelay) {
                        div.style.opacity = '0';
                        div.style.animation = `fadeIn 0.3s forwards ${ (i*size + j) * 0.01 }s`;
                    } else div.style.opacity = '1';
                    
                    container.appendChild(div);
                }
            }
        }

        /* --- DESCARGA ASCII --- */
        function downloadASCII() {
            if(!currentMatrix || currentMatrix.length === 0) return;
            const n = currentMatrix.length;
            const maxNum = n*n;
            const padSize = maxNum.toString().length + 1;
            let content = `GRAPHICS LABS - MAGIC SQUARE (N=${n})\n`;
            content += `Magic Constant: ${document.getElementById('formula-display').innerText.split(': ')[1]}\n`;
            content += "=".repeat(n * padSize) + "\n\n";
            for(let row of currentMatrix) {
                let line = "";
                for(let num of row) line += num.toString().padStart(padSize, ' ');
                content += line + "\n";
            }
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `magic_square_${n}x${n}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        /* --- FONDO ANIMADO --- */
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        let mouse = { x: null, y: null, radius: (canvas.height/100) * (canvas.width/100) };
        window.addEventListener('mousemove', function(e) { mouse.x = e.x; mouse.y = e.y; });

        class Particle {
            constructor(x, y, dx, dy, size) {
                this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.size = size;
                this.number = Math.floor(Math.random() * 10);
            }
            draw() { 
                ctx.font = this.size + 'px monospace';
                ctx.fillStyle = 'rgba(0, 243, 255, 0.4)';
                ctx.fillText(this.number, this.x, this.y);
            }
            update() {
                if(this.x>canvas.width||this.x<0) this.dx=-this.dx;
                if(this.y>canvas.height||this.y<0) this.dy=-this.dy;
                let dx = mouse.x - this.x;
                let dy = mouse.y - this.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                if(dist < mouse.radius + 50){
                    if(mouse.x<this.x && this.x<canvas.width-50) this.x+=2;
                    if(mouse.x>this.x && this.x>50) this.x-=2;
                    if(mouse.y<this.y && this.y<canvas.height-50) this.y+=2;
                    if(mouse.y>this.y && this.y>50) this.y-=2;
                }
                this.x+=this.dx*0.5; this.y+=this.dy*0.5;
                this.draw();
            }
        }
        function init(){
            particlesArray=[];
            let n=(canvas.height*canvas.width)/6000;
            for(let i=0; i<n; i++){
                let size=(Math.random()*15)+10;
                particlesArray.push(new Particle(Math.random()*innerWidth, Math.random()*innerHeight, (Math.random()*1)-0.5, (Math.random()*1)-0.5, size));
            }
        }
        function animate(){ requestAnimationFrame(animate); ctx.clearRect(0,0,innerWidth,innerHeight); for(let i=0; i<particlesArray.length; i++){ particlesArray[i].update(); } }
        window.addEventListener('resize', ()=>{canvas.width=innerWidth;canvas.height=innerHeight;init();});
        init(); animate();

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fadeIn { to { opacity: 1; } }`;
        document.head.appendChild(styleSheet);
        
        generateUserSquare();
    </script>
</body>
</html>
