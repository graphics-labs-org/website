<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magic Square Lab | Graphics Labs</title>
    <style>
        :root {
            --primary: #00f3ff;
            --secondary: #bd00ff;
            --glass: rgba(255, 255, 255, 0.05);
            --border: rgba(255, 255, 255, 0.1);
            --text: #ffffff;
            --muted: #888;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', monospace, sans-serif; }
        
        body {
            background-color: #050505;
            color: var(--text);
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            user-select: none;
        }

        #bg-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; }

        .container {
            position: relative;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- CONTROLES --- */
        .controls {
            background: var(--glass);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin: 20px auto;
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .input-group { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; }
        
        input[type="number"] {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--primary);
            color: var(--primary);
            padding: 10px;
            border-radius: 5px;
            width: 80px;
            font-size: 1.2rem;
            text-align: center;
        }

        button.action-btn {
            background: var(--primary);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.3s;
            text-transform: uppercase;
        }
        button.action-btn:hover { box-shadow: 0 0 15px var(--primary); transform: scale(1.05); }

        button.sagrada-btn {
            background: transparent;
            border: 1px solid var(--secondary);
            color: var(--secondary);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
            font-size: 0.9rem;
        }
        button.sagrada-btn:hover { background: var(--secondary); color: #fff; box-shadow: 0 0 15px var(--secondary); }

        .formula-box {
            font-family: 'Courier New', monospace;
            color: var(--secondary);
            font-size: 1.2rem;
            margin: 10px 0;
            min-height: 1.5em;
            text-shadow: 0 0 5px rgba(189, 0, 255, 0.4);
        }

        /* --- GRID MÁGICO --- */
        #magic-container {
            width: 100%;
            overflow: auto; /* Scroll si es gigante */
            display: flex;
            justify-content: center;
            padding: 10px;
            margin-bottom: 20px;
        }

        #magic-grid {
            display: grid;
            gap: 2px;
            margin: 0 auto;
        }

        .cell {
            background: rgba(0, 243, 255, 0.05);
            border: 1px solid rgba(0, 243, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            border-radius: 2px;
            transition: 0.2s;
            user-select: text; /* Permitir copiar números */
        }
        
        /* Estilos para grids pequeños (bonitos) */
        .cell.fancy:hover { 
            background: var(--primary); 
            color: #000; 
            transform: scale(1.1); 
            box-shadow: 0 0 10px var(--primary); 
            z-index: 2; 
        }

        /* Estilos para grids GIGANTES (>20x20) */
        .cell.dense {
            background: transparent;
            border: none;
            font-family: monospace;
            color: var(--primary);
        }

        .sagrada-highlight { border-color: var(--secondary) !important; color: var(--secondary) !important; font-weight: bold; }

        /* Nav & Footer */
        nav { display: flex; flex-wrap: wrap; gap: 20px; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .nav-links { display: flex; gap: 15px; }
        .nav-btn { 
            text-decoration: none; 
            color: var(--muted); 
            font-size: 0.9rem; 
            border: 1px solid var(--border); 
            padding: 5px 10px; 
            border-radius: 4px; 
            transition: 0.3s;
        }
        .nav-btn:hover { color: var(--primary); border-color: var(--primary); }

        .logo { font-size: 1.2rem; font-weight: bold; color: var(--primary); text-decoration: none; letter-spacing: 2px; }
        
        .lang-switch button { background: transparent; border: 1px solid var(--border); color: var(--muted); padding: 5px 10px; cursor: pointer; border-radius: 4px; margin-left: 2px;}
        .lang-switch button.active { background: var(--primary); color: #000; }
        
        footer { margin-top: auto; padding: 20px; text-align: center; border-top: 1px solid var(--border); background: rgba(0,0,0,0.8); color: var(--muted); font-size: 0.8rem; }

        .error { color: #ff3366; font-size: 0.9rem; margin-top: 10px; display: none; }

    </style>
</head>
<body oncontextmenu="return false;">

    <canvas id="bg-canvas"></canvas>

    <div class="container">
        <nav>
            <div class="nav-links">
                <a href="../../index.html" class="nav-btn">← HUB PRINCIPAL</a>
                <a href="../index.html" class="nav-btn">← HUB MATH</a>
            </div>
            <div class="logo">GRAPHICS LABS</div>
            <div class="lang-switch">
                <button onclick="setLang('es')" id="btn-es" class="active">ES</button>
                <button onclick="setLang('en')" id="btn-en">EN</button>
                <button onclick="setLang('fr')" id="btn-fr">FR</button>
                <button onclick="setLang('de')" id="btn-de">DE</button>
                <button onclick="setLang('pt')" id="btn-pt">PT</button>
                <button onclick="setLang('it')" id="btn-it">IT</button>
                <button onclick="setLang('nl')" id="btn-nl">NL</button>
                <button onclick="setLang('ja')" id="btn-ja">JP</button>
            </div>
        </nav>

        <h1 id="txt-title">CUADRADO MÁGICO</h1>
        <p style="color:var(--muted); margin-bottom: 20px;" id="txt-desc">Generador universal (pares e impares). El caos se convierte en orden.</p>

        <div class="controls">
            <div class="input-group">
                <label id="lbl-size">Tamaño:</label>
                <input type="number" id="size-input" value="3" min="3" max="100" step="1">
                <button class="action-btn" onclick="generateUserSquare()" id="btn-gen">GENERAR</button>
            </div>
            
            <div style="width: 100%; height: 1px; background: var(--border); margin: 10px 0;"></div>
            
            <button class="sagrada-btn" onclick="generateSagrada()" id="btn-sagrada">ver SAGRADA FAMILIA (4x4)</button>
        </div>

        <div class="formula-box" id="formula-display">
            </div>

        <div id="magic-container">
            <div id="magic-grid"></div>
        </div>

    </div>

    <footer>
        <span id="footer-rights">© 2025 Graphics Labs</span>
    </footer>

    <script>
        /* --- 1. IDIOMAS (8 Lenguas) --- */
        const translations = {
            'es': {
                title: "CUADRADO MÁGICO",
                desc: "Generador universal (pares e impares). El caos se convierte en orden.",
                lbl_size: "Tamaño (N):",
                btn_gen: "GENERAR",
                btn_sagrada: "ver SAGRADA FAMILIA (4x4)",
                formula: "Constante Mágica: ",
                sagrada_note: "Nota: Cuadrado de Subirachs (Suma 33, Edad de Cristo)."
            },
            'en': {
                title: "MAGIC SQUARE",
                desc: "Universal generator (odd & even). Chaos becomes order.",
                lbl_size: "Size (N):",
                btn_gen: "GENERATE",
                btn_sagrada: "view SAGRADA FAMILIA (4x4)",
                formula: "Magic Constant: ",
                sagrada_note: "Note: Subirachs Square (Sums 33, Age of Christ)."
            },
            'fr': {
                title: "CARRÉ MAGIQUE",
                desc: "Générateur universel (pair et impair). Le chaos devient ordre.",
                lbl_size: "Taille (N):",
                btn_gen: "GÉNÉRER",
                btn_sagrada: "voir SAGRADA FAMILIA (4x4)",
                formula: "Constante Magique: ",
                sagrada_note: "Note: Carré de Subirachs (Somme 33, Âge du Christ)."
            },
            'de': {
                title: "MAGISCHES QUADRAT",
                desc: "Universalgenerator (gerade & ungerade). Chaos wird Ordnung.",
                lbl_size: "Größe (N):",
                btn_gen: "ERZEUGEN",
                btn_sagrada: "siehe SAGRADA FAMILIA (4x4)",
                formula: "Magische Konstante: ",
                sagrada_note: "Hinweis: Subirachs Quadrat (Summe 33, Alter Christi)."
            },
            'pt': {
                title: "QUADRADO MÁGICO",
                desc: "Gerador universal (pares e ímpares). O caos torna-se ordem.",
                lbl_size: "Tamanho (N):",
                btn_gen: "GERAR",
                btn_sagrada: "ver SAGRADA FAMILIA (4x4)",
                formula: "Constante Mágica: ",
                sagrada_note: "Nota: Quadrado de Subirachs (Soma 33, Idade de Cristo)."
            },
            'it': {
                title: "QUADRATO MAGICO",
                desc: "Generatore universale (pari e dispari). Il caos diventa ordine.",
                lbl_size: "Dimensione (N):",
                btn_gen: "GENERARE",
                btn_sagrada: "vedi SAGRADA FAMILIA (4x4)",
                formula: "Costante Magica: ",
                sagrada_note: "Nota: Quadrato di Subirachs (Somma 33, Età di Cristo)."
            },
            'nl': {
                title: "MAGISCH VIERKANT",
                desc: "Universele generator (even & oneven). Chaos wordt orde.",
                lbl_size: "Grootte (N):",
                btn_gen: "GENEREREN",
                btn_sagrada: "zie SAGRADA FAMILIA (4x4)",
                formula: "Magische Constante: ",
                sagrada_note: "Opmerking: Subirachs Vierkant (Som 33, Leeftijd van Christus)."
            },
            'ja': {
                title: "魔方陣",
                desc: "ユニバーサルジェネレーター（偶数と奇数）。カオスが秩序になる。",
                lbl_size: "サイズ (N):",
                btn_gen: "生成する",
                btn_sagrada: "サグラダ・ファミリア (4x4)",
                formula: "魔法定数: ",
                sagrada_note: "注：スビラクスの方陣（合計33、キリストの年齢）。"
            }
        };

        let currentLang = 'es';

        function setLang(lang) {
            currentLang = lang;
            const t = translations[lang];
            document.getElementById('txt-title').innerText = t.title;
            document.getElementById('txt-desc').innerText = t.desc;
            document.getElementById('lbl-size').innerText = t.lbl_size;
            document.getElementById('btn-gen').innerText = t.btn_gen;
            document.getElementById('btn-sagrada').innerText = t.btn_sagrada;
            
            document.querySelectorAll('.lang-switch button').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + lang).classList.add('active');
            
            // Refrescar formula si existe
            const formulaBox = document.getElementById('formula-display');
            if(formulaBox.innerText.includes(':')) {
                const val = formulaBox.innerText.split(': ')[1];
                formulaBox.innerText = t.formula + val;
            }
        }

        /* --- 2. LÓGICA MATEMÁTICA COMPLEJA --- */

        function generateUserSquare() {
            let n = parseInt(document.getElementById('size-input').value);
            if(n < 3) n = 3; 
            if(n > 100) n = 100; // Límite de seguridad
            document.getElementById('size-input').value = n;

            // Formula: M = n(n^2 + 1) / 2
            const magicConstant = (n * (n*n + 1)) / 2;
            document.getElementById('formula-display').innerText = translations[currentLang].formula + magicConstant;

            let matrix;

            if (n % 2 !== 0) {
                // Caso 1: IMPAR (Método Siamés)
                matrix = generateOdd(n);
            } else if (n % 4 === 0) {
                // Caso 2: DOBLEMENTE PAR (n = 4, 8, 12...)
                matrix = generateDoublyEven(n);
            } else {
                // Caso 3: PAR SIMPLE (n = 6, 10, 14...) - Método Strachey (El más difícil)
                matrix = generateSinglyEven(n);
            }

            drawGrid(matrix, n);
        }

        // Algoritmo para Impares (Siamese Method)
        function generateOdd(n) {
            let square = Array.from({ length: n }, () => Array(n).fill(0));
            let i = 0;
            let j = Math.floor(n / 2);
            for (let num = 1; num <= n * n; num++) {
                square[i][j] = num;
                let nextI = (i - 1 + n) % n;
                let nextJ = (j + 1) % n;
                if (square[nextI][nextJ] !== 0) {
                    i = (i + 1) % n;
                } else {
                    i = nextI;
                    j = nextJ;
                }
            }
            return square;
        }

        // Algoritmo para Doblemente Pares (4, 8, 12...)
        function generateDoublyEven(n) {
            let square = Array.from({ length: n }, () => Array(n).fill(0));
            let i, j;
            
            // Llenar en orden secuencial 1 a n^2
            for (i = 0; i < n; i++) {
                for (j = 0; j < n; j++) {
                    square[i][j] = (n * i) + j + 1;
                }
            }
            
            // Cambiar valores en esquinas y centro según reglas de simetría
            // Regla: Cambiar si (i % 4 == j % 4) o (i % 4 + j % 4 == 3)
            for (i = 0; i < n; i++) {
                for (j = 0; j < n; j++) {
                    let inCorner = (i % 4 === 0 || i % 4 === 3) && (j % 4 === 0 || j % 4 === 3);
                    let inCenter = (i % 4 === 1 || i % 4 === 2) && (j % 4 === 1 || j % 4 === 2);
                    
                    if (inCorner || inCenter) {
                        square[i][j] = (n * n + 1) - square[i][j];
                    }
                }
            }
            return square;
        }

        // Algoritmo para Pares Simples (6, 10, 14...) - Método Strachey
        function generateSinglyEven(n) {
            let halfN = n / 2;
            let subGrid = generateOdd(halfN); // Usamos el método impar para los subcuadrantes
            let grid = Array.from({ length: n }, () => Array(n).fill(0));

            // Cuadrantes: A (Arriba-Izq), B (Abajo-Der), C (Arriba-Der), D (Abajo-Izq)
            // Strachey asigna: A=Base, B=Base+n^2/4, C=Base+2*n^2/4, D=Base+3*n^2/4
            // Orden standard: A C D B (Top-L, Top-R, Bot-L, Bot-R) ? No, Strachey usa:
            // A=TopLeft, B=BottomRight, C=TopRight, D=BottomLeft
            // Valores: A(1..k), D(k+1..2k), B(2k+1..3k), C(3k+1..4k) donde k = (n/2)^2
            
            let k = halfN * halfN;
            
            for (let i = 0; i < halfN; i++) {
                for (let j = 0; j < halfN; j++) {
                    grid[i][j] = subGrid[i][j];             // A (Top-Left)
                    grid[i + halfN][j + halfN] = subGrid[i][j] + k; // B (Bottom-Right)
                    grid[i][j + halfN] = subGrid[i][j] + 2 * k; // C (Top-Right)
                    grid[i + halfN][j] = subGrid[i][j] + 3 * k; // D (Bottom-Left)
                }
            }

            // Intercambio de columnas (Swap rules)
            let swapCols = Math.floor(n / 4);
            
            for (let i = 0; i < halfN; i++) {
                for (let j = 0; j < swapCols; j++) {
                    // Swap Left side A and D
                    if (i === Math.floor(halfN / 2)) {
                        // Fila central del subcuadrante: swap desde columna 1
                        swap(grid, i, j + 1, i + halfN, j + 1);
                    } else {
                        // Otras filas: swap normal
                        swap(grid, i, j, i + halfN, j);
                    }
                }
            }
            
            // Swap Right side C and B (last m-1 columns)
            let m = swapCols - 1;
            if (m > 0) {
                for (let i = 0; i < halfN; i++) {
                    for (let j = 0; j < m; j++) {
                        let col = n - 1 - j;
                        swap(grid, i, col, i + halfN, col);
                    }
                }
            }

            return grid;
        }

        function swap(grid, r1, c1, r2, c2) {
            let temp = grid[r1][c1];
            grid[r1][c1] = grid[r2][c2];
            grid[r2][c2] = temp;
        }

        function generateSagrada() {
            const sagrada = [
                [1, 14, 14, 4],
                [11, 7, 6, 9],
                [8, 10, 10, 5],
                [13, 2, 3, 15]
            ];
            document.getElementById('formula-display').innerText = translations[currentLang].formula + "33 (" + translations[currentLang].sagrada_note + ")";
            drawGrid(sagrada, 4, true);
        }

        function drawGrid(matrix, size, isSpecial = false) {
            const container = document.getElementById('magic-grid');
            container.innerHTML = '';
            
            // AJUSTE DE TAMAÑO PARA GRIDS GIGANTES
            let cellSize, fontSize;
            let isDense = false;

            if (size <= 10) {
                cellSize = '50px'; fontSize = '1.2rem';
            } else if (size <= 20) {
                cellSize = '30px'; fontSize = '0.9rem';
            } else if (size <= 50) {
                cellSize = '20px'; fontSize = '0.7rem'; isDense = true;
            } else {
                cellSize = '12px'; fontSize = '0.5rem'; isDense = true;
            }
            
            container.style.gridTemplateColumns = `repeat(${size}, ${cellSize})`;
            
            // Retardo de animación basado en tamaño (si es enorme, sin delay)
            let useDelay = size < 15;

            for (let i = 0; i < size; i++) {
                for (let j = 0; j < size; j++) {
                    let val = matrix[i][j];
                    let div = document.createElement('div');
                    
                    div.className = isDense ? 'cell dense' : 'cell fancy';
                    if (isSpecial && (val === 10 || val === 14)) div.classList.add('sagrada-highlight');
                    
                    div.style.width = cellSize;
                    div.style.height = cellSize; // Forzar cuadrado
                    div.style.fontSize = fontSize;
                    div.innerText = val;
                    
                    if (useDelay) {
                        div.style.opacity = '0';
                        div.style.animation = `fadeIn 0.3s forwards ${ (i*size + j) * 0.01 }s`;
                    } else {
                        div.style.opacity = '1'; // Mostrar de golpe si son muchos
                    }
                    
                    container.appendChild(div);
                }
            }
        }

        /* --- PARTICULAS DE FONDO (Números) --- */
        const canvas = document.getElementById('bg-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        let particlesArray;
        let mouse = { x: null, y: null, radius: (canvas.height/100) * (canvas.width/100) };
        window.addEventListener('mousemove', function(e) { mouse.x = e.x; mouse.y = e.y; });

        class Particle {
            constructor(x, y, dx, dy, size) {
                this.x = x; this.y = y; this.dx = dx; this.dy = dy; this.size = size;
                this.number = Math.floor(Math.random() * 10); // Numero 0-9
            }
            draw() { 
                ctx.font = this.size + 'px monospace';
                ctx.fillStyle = '#00f3ff';
                ctx.fillText(this.number, this.x, this.y);
            }
            update() {
                if(this.x>canvas.width||this.x<0) this.dx=-this.dx;
                if(this.y>canvas.height||this.y<0) this.dy=-this.dy;
                
                let dx = mouse.x - this.x;
                let dy = mouse.y - this.y;
                let distance = Math.sqrt(dx*dx + dy*dy);
                if(distance < mouse.radius + 50){
                    if(mouse.x<this.x && this.x<canvas.width-50) this.x+=2;
                    if(mouse.x>this.x && this.x>50) this.x-=2;
                    if(mouse.y<this.y && this.y<canvas.height-50) this.y+=2;
                    if(mouse.y>this.y && this.y>50) this.y-=2;
                }
                
                this.x+=this.dx*0.5; this.y+=this.dy*0.5;
                this.draw();
            }
        }

        function init(){
            particlesArray=[];
            let n=(canvas.height*canvas.width)/6000;
            for(let i=0; i<n; i++){
                let size=(Math.random()*15)+10; // Tamaño fuente
                particlesArray.push(new Particle(Math.random()*innerWidth, Math.random()*innerHeight, (Math.random()*1)-0.5, (Math.random()*1)-0.5, size));
            }
        }
        function animate(){
            requestAnimationFrame(animate); 
            ctx.clearRect(0,0,innerWidth,innerHeight);
            for(let i=0; i<particlesArray.length; i++){
                particlesArray[i].update();
                // Conexiones (opcional, lo quito para que se lean mejor los números)
                /* for(let j=i; j<particlesArray.length; j++){ ... } */
            }
        }
        window.addEventListener('resize', ()=>{canvas.width=innerWidth;canvas.height=innerHeight;init();});
        init(); animate();

        const styleSheet = document.createElement("style");
        styleSheet.innerText = `@keyframes fadeIn { to { opacity: 1; } }`;
        document.head.appendChild(styleSheet);
        
        // Iniciar
        generateUserSquare();
    </script>
</body>
</html>
